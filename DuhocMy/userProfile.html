<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" type="image/png" href="./img/smallLogo.png">
    <title>DuHocMy</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script language="JavaScript" src="js/logout.js"></script>
    <script language="JavaScript" src="js/login.js"></script>
    <script language="JavaScript" src="js/cookie.js"></script>
    <script language="JavaScript" src="js/chatPopup.js"></script>
    <script language="JavaScript" src="js/rating.js"></script>
    <script language="JavaScript" src="js/rateValue.js"></script>

</head>
<body>

<div class ="container-fluid">
    <div class="row"><div class = col-sm><hr class="mb-3"></div></div>
    <div class="row">
        <div class="col-3">
        <div class="info" style="position: fixed">
            <img id ="avatar" src="img/smallLogo.png" alt="ProfilePic"><br>
            <div id ="email">
                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-envelope" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383l-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z"/>
                </svg>:
            </div>
            <div id ="tel">
                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-telephone" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/>
                </svg>:
            </div>
        </div>

        </div>
        <div class="col-9">
            <div class="container-fluid">
                <div class="row">
                    <div class="col">
                        <div class="username">

                        </div>
                        <div id="bio">
                        </div><br>
                        <div class="rateDisplay"></div>
                        <div id ="rate">Rating:</div><br>
                        <div class="username">Rate </div>
                        <div class="rating">
                            <span><input type="radio" name="rating" id="str5" value="5"><label class="starShape" for="str5"></label></span>
                            <span><input type="radio" name="rating" id="str4" value="4"><label class="starShape" for="str4"></label></span>
                            <span><input type="radio" name="rating" id="str3" value="3"><label class="starShape" for="str3"></label></span>
                            <span><input type="radio" name="rating" id="str2" value="2"><label class="starShape" for="str2"></label></span>
                            <span><input type="radio" name="rating" id="str1" value="1"><label class="starShape "for="str1"></label></span>
                       </div>

                    </div>
                </div>
                <div class="row"><div class = col-sm><hr class="mb-3"></div></div>
                <div class="row" id="applyArea"></div>
                <div class="row"><div class = col-sm><hr class="mb-3"></div></div>

                <div class="row mb-5" id="displayItem">

                </div>
            </div>

            </div>
        </div>
    </div>

    <div id="conversationBox">
        <div class ="container-fluid">
            <div class="row">
                <div class="col">
                    <button class="text-left btn btn-primary" type="submit" id="chatMateName"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chat-dots" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                        <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                    </svg></button>
                    <iframe class="border border-primary rounded" src="chatBox.html" id="chatBox"></iframe>
                </div>
            </div>
        </div>

    </div>
</div>
<script>
    $(function (e){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const username = urlParams.get('profileName');
        if(getCookie('username')===username){
            window.location.href ="myProfile.html";
        }

        $('#chatMateName').append(username);
        $('.starShape').load('starShape.html');
        $.ajax({
            type: 'GET',
            url: 'api/user.php/user',
            data: {username:username},
            success: function (data){
                const userInfo = JSON.parse(data);
                if (userInfo.hasOwnProperty('username')){
                    $('#avatar').attr("src", "img/avatar/"+userInfo.avatar);
                    $('.username').append('<b>'+userInfo.fullname+'</b>');
                    $('#email').append(userInfo.email);
                    $('#tel').append(userInfo.tel);
                    $('#bio').append(userInfo.bio);
                }
            }
        })
        $('#chatBox').attr('src','chatBox.html?chatMate='+username+'#lastMess');
        rateSubmit(username);

        $.ajax({
            type: 'GET',
            url: '/DuhocMy/api/rating.php/rate',
            data: {username: username},
            success: function (data) {
                const aveRate = JSON.parse(data);
                if(aveRate!="No result"){
                    $('.rateDisplay').append(rateValue(parseInt(aveRate.aveRateVal)));
                    $('#rate').append(Math.round((parseFloat(aveRate.aveRateVal) + Number.EPSILON) * 100) / 100+'/5');
                }

            }
        });

        if(urlParams.get('rentalId')) {
            rentalId = urlParams.get('rentalId');
            $.ajax({
                type: 'GET',
                url: '/DuhocMy/api/room.php/room',
                data: {rentalId:rentalId},
                success: function (data){
                    const rooms = JSON.parse(data);
                    if(rooms!="No result"){
                        $.each(rooms,function (index, room){
                            $("#displayItem").append('<div class="col-auto mt-3">\n' +
                                '                        <iframe width="1000"\n' +
                                '                                height="600"\n' +
                                '                                frameborder="0" style="border:0"\n' +
                                '                                id ="map" src="blank.html" allowfullscreen>\n' +
                                '                        </iframe>\n' +
                                '\n' +
                                '                    </div>');
                            $('#map').attr('src', room.mapLink);
                            if(room.gallery!="placeholderImg"){
                                var folder = "img/room/"+room.gallery+"/";
                                $.ajax({
                                    url : folder,
                                    success: function (data) {
                                        $(data).find("a").attr("href", function (i, val) {
                                            if( val.match(/\.(jpe?g|png|gif)$/) ) {
                                                $("#displayItem").append('<div class ="col-auto mt-3"><img class ="largePreviewImg" src="'+folder+val+'" alt="img"></div>')
                                            }
                                        });

                                        $('#displayItem').append(
                                            '<div class= "col-12 border border-primary rounded mt-3">'+
                                            '   <h5>Address: ' + room.address +', '+room.city+', '+ room.state+', '+room.zip +'</h5>'+
                                            '   <h6>Price: $' + room.price + '/month</h6>'+
                                            '   <div style="white-space: pre-wrap;">'+room.description+'</div>'+
                                            '</div>'
                                        );
                                    }
                                });
                            }else{
                                $('#displayItem').append(
                                    '<div class= "col-12 border border-primary mt-3">'+
                                    '   <h5>Address: ' + room.address +', '+room.city+', '+ room.state+', '+room.zip +'</h5>'+
                                    '   <h6>Price: $' + room.price + '/month</h6>'+
                                    '   <div style="white-space: pre-wrap;">'+room.description+'</div>'+
                                    '</div>'
                                );
                            }





                        });
                    }
                }
            })
        }

        if(urlParams.get('jobPostId')) {
            jobPostId = urlParams.get('jobPostId');
            $.ajax({
                type: 'GET',
                url: '/DuhocMy/api/job.php/job',
                data: {jobPostId:jobPostId},
                success: function (data){
                    const jobs = JSON.parse(data);
                    if(jobs!="No result"){
                        $.each(jobs,function (index, job){
                            $('#displayItem').append(
                                '<div class= "col-12 border border-info rounded mt-3">'+
                                '   <h5>Recruiting: ' + job.jobTitle + '</h5>\n' +
                                '   <h6>' + job.companyName + '</h6>\n' +
                                '   <div>Address: ' + job.address +', '+job.city+', '+ job.state+', '+job.zip +'</div>\n' +
                                '   <div>Salary: $' + job.salary+'/month</div>\n' +
                                '   <div>Description:</div>'+
                                '   <div style="white-space: pre-wrap;">'+job.description+'</div>'+
                                '</div>'
                            );
                            $("#displayItem").append('<div class="col-auto mt-3">\n' +
                                '                        <iframe width="1000"\n' +
                                '                                height="600"\n' +
                                '                                frameborder="0" style="border:0"\n' +
                                '                                id ="map" src="blank.html" allowfullscreen>\n' +
                                '                        </iframe>\n' +
                                '\n' +
                                '                    </div>');
                            $('#map').attr('src', job.mapLink);
                            if(job.gallery!="placeholderImg"){
                                var folder = "img/job/"+job.gallery+"/";
                                $.ajax({
                                    url : folder,
                                    success: function (data) {
                                        $(data).find("a").attr("href", function (i, val) {
                                            if( val.match(/\.(jpe?g|png|gif)$/) ) {
                                                $("#displayItem").append('<div class ="col-auto mt-3"><img class ="largePreviewImg" src="'+folder+val+'" alt="img"></div>')
                                            }
                                        });


                                    }
                                });
                            }

                            // $('#applyBtn').click(function(e){
                            //     e.preventDefault();
                            //     $("#browse").trigger('click');
                            // })
                            //
                            // $('#browse').change(function(e){
                            //     var filename= $('#browse').val();
                            //     var indexDot = filename.lastIndexOf('.')+1;
                            //     var fileExt = filename.substr(indexDot, filename.length).toLowerCase();
                            //     var acceptedFileExt =["jpg","png", "jpeg", "doc", "docx", "pdf", "txt"];
                            //     if (!acceptedFileExt.includes(fileExt))
                            //     {
                            //         Swal.fire({
                            //             title: 'Error',
                            //             text: 'We are currently not be able to support your file type! Please try again!',
                            //             icon: 'error'
                            //         })
                            //     }else{
                            //         filename = this.files[0].name
                            //         $('#filename').html(filename);
                            //     }
                            // });
                            //
                            // $('#submitResumeBtn').click(function(e){
                            //     const valid = this.form.checkValidity();
                            //     if(valid){
                            //         var formData = new FormData();
                            //         e.preventDefault();
                            //         if($('#browse')[0].files[0] && $('#browse')[0].files){
                            //             formData.append("file",$('#browse')[0].files[0]);
                            //             formData.append('username', getCookie('username'));
                            //             formData.append('jobPostId', job.jobPostId);
                            //
                            //                 $.ajax({
                            //                 type:"POST",
                            //                 url: "api/application.php/jobApply",
                            //                 data: formData,
                            //                 processData: false,
                            //                 contentType: false,
                            //                 success: function(data){
                            //                     var success = JSON.parse(data);
                            //                     if ($.trim(success) == "Success"){
                            //                         Swal.fire({
                            //                             title: 'Success',
                            //                             text: 'Résumé submit successfully',
                            //                             icon: 'success'
                            //                         })
                            //                         setTimeout('window.location.reload()',500);
                            //                     }else{
                            //                         Swal.fire({
                            //                             title: 'Error',
                            //                             text: data,
                            //                             icon: 'error'
                            //                         })
                            //                     }
                            //                 },
                            //                 error: function(data){
                            //                     Swal.fire({
                            //                         title: 'Errors',
                            //                         text: 'There were errors connecting to server.',
                            //                         icon: 'error'
                            //                     })
                            //                 }
                            //             });
                            //         }else{
                            //             Swal.fire({
                            //                 title: 'Error',
                            //                 text: "No file has been selected",
                            //                 icon: 'error'
                            //             })
                            //         }
                            //     }
                            //
                            // });

                        });
                    }
                }
            })
        }

        if(urlParams.get('groupId')) {
            groupId = urlParams.get('groupId');
            $.ajax({
                type: 'GET',
                url: '/DuhocMy/api/group.php/group',
                data: {groupId:groupId},
                success: function (data){
                    const groups = JSON.parse(data);
                    if(groups!="No result"){
                        $.each(groups,function (index, group){
                            $('#displayItem').append(
                                '<div class= "col-12 border border-info rounded mt-3">'+
                                '   <h5>' + group.groupName + '</h5>\n' +
                                '   <h6>Leader: ' + group.leaderFullname + '</h6>\n' +
                                '   <div>Address: ' + group.address +', '+group.city+', '+ group.state+', '+group.zip +'</div>\n' +
                                '   <div>Description:</div>'+
                                '   <div style="white-space: pre-wrap;">'+group.description+'</div>'+
                                '</div>'
                            );
                            $("#displayItem").append('<div class="col-auto mt-3">\n' +
                                '                        <iframe width="1000"\n' +
                                '                                height="600"\n' +
                                '                                frameborder="0" style="border:0"\n' +
                                '                                id ="map" src="blank.html" allowfullscreen>\n' +
                                '                        </iframe>\n' +
                                '\n' +
                                '                    </div>');
                            $('#map').attr('src', group.mapLink);
                            if(group.gallery!="placeholderImg"){
                                var folder = "img/group/"+group.gallery+"/";
                                $.ajax({
                                    url : folder,
                                    success: function (data) {
                                        $(data).find("a").attr("href", function (i, val) {
                                            if( val.match(/\.(jpe?g|png|gif)$/) ) {
                                                $("#displayItem").append('<div class ="col-auto mt-3"><img class ="largePreviewImg" src="'+folder+val+'" alt="img"></div>')
                                            }
                                        });


                                    }
                                });
                            }

                            // $('#applyBtn').click(function(e){
                            //     e.preventDefault();
                            //     $("#browse").trigger('click');
                            // })
                            //
                            // $('#browse').change(function(e){
                            //     var filename= $('#browse').val();
                            //     var indexDot = filename.lastIndexOf('.')+1;
                            //     var fileExt = filename.substr(indexDot, filename.length).toLowerCase();
                            //     var acceptedFileExt =["jpg","png", "jpeg", "doc", "docx", "pdf", "txt"];
                            //     if (!acceptedFileExt.includes(fileExt))
                            //     {
                            //         Swal.fire({
                            //             title: 'Error',
                            //             text: 'We are currently not be able to support your file type! Please try again!',
                            //             icon: 'error'
                            //         })
                            //     }else{
                            //         filename = this.files[0].name
                            //         $('#filename').html(filename);
                            //     }
                            // });
                            //
                            // $('#submitResumeBtn').click(function(e){
                            //     const valid = this.form.checkValidity();
                            //     if(valid){
                            //         var formData = new FormData();
                            //         e.preventDefault();
                            //         if($('#browse')[0].files[0] && $('#browse')[0].files){
                            //             formData.append("file",$('#browse')[0].files[0]);
                            //             formData.append('username', getCookie('username'));
                            //             formData.append('jobPostId', job.jobPostId);
                            //
                            //                 $.ajax({
                            //                 type:"POST",
                            //                 url: "api/application.php/jobApply",
                            //                 data: formData,
                            //                 processData: false,
                            //                 contentType: false,
                            //                 success: function(data){
                            //                     var success = JSON.parse(data);
                            //                     if ($.trim(success) == "Success"){
                            //                         Swal.fire({
                            //                             title: 'Success',
                            //                             text: 'Résumé submit successfully',
                            //                             icon: 'success'
                            //                         })
                            //                         setTimeout('window.location.reload()',500);
                            //                     }else{
                            //                         Swal.fire({
                            //                             title: 'Error',
                            //                             text: data,
                            //                             icon: 'error'
                            //                         })
                            //                     }
                            //                 },
                            //                 error: function(data){
                            //                     Swal.fire({
                            //                         title: 'Errors',
                            //                         text: 'There were errors connecting to server.',
                            //                         icon: 'error'
                            //                     })
                            //                 }
                            //             });
                            //         }else{
                            //             Swal.fire({
                            //                 title: 'Error',
                            //                 text: "No file has been selected",
                            //                 icon: 'error'
                            //             })
                            //         }
                            //     }
                            //
                            // });

                        });
                    }
                }
            })
        }

    });



</script>
</body>
</html>